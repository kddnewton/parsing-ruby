#!/usr/bin/env node

const esbuild = require("esbuild");
const cssModulesPlugin = require("esbuild-css-modules-plugin");
const fs = require("fs");
const path = require("path");

const outdir = path.join(__dirname, "../docs")
const deletes = [];

fs.readdirSync(outdir).forEach((filepath) => {
  if (filepath.match(/\.(css|js)(\.map)?$/)) {
    deletes.push(new Promise((resolve, reject) => {
      fs.unlink(path.join(outdir, filepath), (error) => {
        if (error) {
          reject(error);
        } else {
          resolve();
        }
      });
    }));
  }
});

Promise.all(deletes).then(() => {
  esbuild.build({
    bundle: true,
    entryPoints: [path.join(__dirname, "../src/index.tsx")],
    format: "esm",
    minify: true,
    outdir,
    plugins: [cssModulesPlugin()],
    sourcemap: true,
    splitting: true,
    target: "es6"
  });
});
